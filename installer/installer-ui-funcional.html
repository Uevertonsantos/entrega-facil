<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instalador Entrega F치cil</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .installer-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      max-width: 700px;
      width: 90%;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #333;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header .icon {
      font-size: 3em;
      margin-bottom: 10px;
    }
    
    .step {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    .step.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-group {
      margin: 20px 0;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e1e1;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      margin: 10px 5px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .btn-secondary {
      background: #f8f9fa;
      color: #333;
      border: 2px solid #e1e1e1;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .status {
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: center;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .actions {
      text-align: center;
      margin-top: 30px;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .progress-message {
      margin-top: 15px;
      font-size: 16px;
      color: #333;
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 600px) {
      .config-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="installer-container">
    <div class="header">
      <div class="icon">游뚴</div>
      <h1>Entrega F치cil</h1>
      <p>Instalador do Sistema de Entregas Local</p>
    </div>
    
    <!-- Tela de Configura칞칚o -->
    <div class="step active" id="configStep">
      <h2>Configura칞칚o do Sistema</h2>
      <p>Informe os dados do seu estabelecimento:</p>
      
      <div class="form-group">
        <label>Nome do Estabelecimento:</label>
        <input type="text" id="businessName" class="form-control" placeholder="Ex: Padaria do Jo칚o" required>
      </div>
      
      <div class="config-grid">
        <div class="form-group">
          <label>Telefone:</label>
          <input type="tel" id="businessPhone" class="form-control" placeholder="(11) 99999-9999" required>
        </div>
        
        <div class="form-group">
          <label>Porta do Sistema:</label>
          <input type="number" id="port" class="form-control" value="3000" min="1000" max="9999" required>
        </div>
      </div>
      
      <div class="form-group">
        <label>Endere칞o Completo:</label>
        <input type="text" id="businessAddress" class="form-control" placeholder="Rua, n칰mero, bairro, cidade" required>
      </div>
      
      <div class="form-group">
        <label>Email (opcional):</label>
        <input type="email" id="businessEmail" class="form-control" placeholder="contato@estabelecimento.com">
      </div>
      
      <div class="form-group">
        <label>Pasta de Instala칞칚o:</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="installPath" class="form-control" readonly>
          <button type="button" class="btn btn-secondary" onclick="selectFolder()">Alterar</button>
        </div>
      </div>
      
      <div class="actions">
        <button type="button" class="btn btn-primary" onclick="startInstallation()">Instalar Sistema</button>
      </div>
    </div>
    
    <!-- Tela de Instala칞칚o -->
    <div class="step" id="installStep">
      <h2>Instala칞칚o em Andamento</h2>
      <p>Instalando o sistema, aguarde...</p>
      
      <div class="loading">
        <div class="spinner"></div>
        <div class="progress-message" id="progressMessage">Preparando instala칞칚o...</div>
      </div>
      
      <div class="status" id="installResult" style="display: none;"></div>
      
      <div class="actions">
        <button type="button" class="btn btn-primary" id="testBtn" onclick="testSystem()" style="display: none;">Testar Sistema</button>
        <button type="button" class="btn btn-primary" id="openBtn" onclick="openSystem()" style="display: none;">Abrir Sistema</button>
        <button type="button" class="btn btn-secondary" onclick="closeApp()" style="display: none;" id="closeBtn">Fechar</button>
      </div>
    </div>
  </div>
  
  <script>
    const { ipcRenderer } = require('electron');
    
    let systemInfo = {};
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', async () => {
      await checkSystem();
    });
    
    // Verificar sistema
    async function checkSystem() {
      try {
        systemInfo = await ipcRenderer.invoke('check-system');
        
        if (systemInfo.success) {
          document.getElementById('installPath').value = systemInfo.installPath;
          document.getElementById('port').value = systemInfo.freePort;
          
          // Preencher com dados do exemplo se dispon칤vel
          if (systemInfo.isWindows) {
            document.getElementById('businessName').value = 'ABATEDOURO PENA BRANCA';
            document.getElementById('businessPhone').value = '(75) 9939-0398';
            document.getElementById('businessAddress').value = 'RUA RUA BAIXA DA AREIA, 0 - VILA, CONDE/BA';
          }
        } else {
          showStatus('error', systemInfo.error);
        }
      } catch (error) {
        showStatus('error', 'Erro ao verificar sistema: ' + error.message);
      }
    }
    
    // Selecionar pasta
    async function selectFolder() {
      try {
        const newPath = await ipcRenderer.invoke('select-folder');
        if (newPath) {
          document.getElementById('installPath').value = newPath;
        }
      } catch (error) {
        alert('Erro ao selecionar pasta: ' + error.message);
      }
    }
    
    // Validar formul치rio
    function validateForm() {
      const required = ['businessName', 'businessPhone', 'businessAddress', 'port'];
      let valid = true;
      
      required.forEach(field => {
        const input = document.getElementById(field);
        if (!input.value.trim()) {
          input.style.borderColor = '#dc3545';
          valid = false;
        } else {
          input.style.borderColor = '#e1e1e1';
        }
      });
      
      return valid;
    }
    
    // Iniciar instala칞칚o
    async function startInstallation() {
      if (!validateForm()) {
        alert('Por favor, preencha todos os campos obrigat칩rios.');
        return;
      }
      
      // Trocar para tela de instala칞칚o
      document.getElementById('configStep').classList.remove('active');
      document.getElementById('installStep').classList.add('active');
      
      // Mostrar loading
      document.querySelector('.loading').style.display = 'block';
      
      const config = {
        businessName: document.getElementById('businessName').value,
        businessPhone: document.getElementById('businessPhone').value,
        businessAddress: document.getElementById('businessAddress').value,
        businessEmail: document.getElementById('businessEmail').value,
        port: parseInt(document.getElementById('port').value)
      };
      
      try {
        const result = await ipcRenderer.invoke('install-system', config);
        
        if (result.success) {
          document.querySelector('.loading').style.display = 'none';
          showStatus('success', \`Sistema instalado com sucesso!\\n\\nPasta: \${result.installPath}\\nPorta: \${result.port}\\nNeg칩cio: \${result.businessName}\`);
          
          // Mostrar bot칫es
          document.getElementById('testBtn').style.display = 'inline-block';
          document.getElementById('openBtn').style.display = 'inline-block';
          document.getElementById('closeBtn').style.display = 'inline-block';
        } else {
          document.querySelector('.loading').style.display = 'none';
          showStatus('error', 'Erro na instala칞칚o: ' + result.error);
        }
      } catch (error) {
        document.querySelector('.loading').style.display = 'none';
        showStatus('error', 'Erro na instala칞칚o: ' + error.message);
      }
    }
    
    // Testar sistema
    async function testSystem() {
      updateProgress('Testando sistema...');
      
      try {
        const result = await ipcRenderer.invoke('test-system');
        
        if (result.success) {
          showStatus('success', 'Sistema testado com sucesso! Pronto para uso.');
        } else {
          showStatus('error', 'Erro no teste: ' + result.output);
        }
      } catch (error) {
        showStatus('error', 'Erro no teste: ' + error.message);
      }
    }
    
    // Abrir sistema
    async function openSystem() {
      try {
        const result = await ipcRenderer.invoke('open-system');
        
        if (result.success) {
          showStatus('success', 'Sistema aberto! Verifique a janela do navegador.');
        } else {
          showStatus('error', 'Erro ao abrir sistema: ' + result.error);
        }
      } catch (error) {
        showStatus('error', 'Erro ao abrir sistema: ' + error.message);
      }
    }
    
    // Fechar aplica칞칚o
    async function closeApp() {
      await ipcRenderer.invoke('close-app');
    }
    
    // Mostrar status
    function showStatus(type, message) {
      const statusDiv = document.getElementById('installResult');
      statusDiv.style.display = 'block';
      statusDiv.className = \`status status-\${type}\`;
      statusDiv.innerHTML = message.replace(/\\n/g, '<br>');
    }
    
    // Atualizar progresso
    function updateProgress(message) {
      document.getElementById('progressMessage').textContent = message;
    }
    
    // Escutar progresso da instala칞칚o
    ipcRenderer.on('install-progress', (event, message) => {
      updateProgress(message);
    });
  </script>
</body>
</html>